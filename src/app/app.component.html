<div class="app">
  <div class="container">
    <!-- Greeting -->
    <div class="greeting">
      <span class="greeting-icon">üåê</span>
      <h1 class="greeting-text">{{ getGreeting() }}</h1>
    </div>

    <!-- Input Area -->
    <form class="input-container" [formGroup]="queryForm" (ngSubmit)="onSubmit()">
      <div class="input-box">
        <textarea
          #textareaRef
          class="input-field"
          formControlName="query"
          placeholder="üí¨ How can I help you today?"
          (keydown)="handleKeyDown($event)"
          rows="1"
          [disabled]="loading"
        ></textarea>
        
        <div class="input-footer">
          <div class="input-footer-left">
            <label for="file-upload" class="attach-button" title="Attach JPEG or PDF">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
              </svg>
              <input
                id="file-upload"
                type="file"
                accept=".jpeg,.jpg,.pdf,image/jpeg,application/pdf"
                (change)="handleFileChange($event)"
                style="display: none"
              />
            </label>
          </div>
          
          <div class="input-footer-right">
            <button
              type="submit"
              class="send-button"
              [disabled]="!queryForm.valid || loading"
              aria-label="Send"
            >
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M2 8L14 8M10 4L14 8L10 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </form>

    <!-- Loading State -->
    <div *ngIf="loading" class="status-message loading">
      <div class="spinner"></div>
      <span>‚ö° Processing your request...</span>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="status-message error">
      <span>‚ö†Ô∏è {{ error }}</span>
    </div>

    <!-- Task Selector (when classification is UNKNOWN) -->
    <div *ngIf="showTaskSelector && availableTasks.length > 0" class="task-selector-container">
      <div class="task-selector">
        <h3>‚ö†Ô∏è I couldn't understand that. What would you like to do?</h3>
        <p class="original-query">Query: "{{ originalQuery }}"</p>
        <div class="task-options">
          <div 
            *ngFor="let task of availableTasks" 
            class="task-option"
            (click)="handleTaskSelection(task.taskId)"
          >
            <div class="task-option-header">
              <span class="task-option-icon">‚óã</span>
              <span class="task-option-name">{{ task.taskName }}</span>
            </div>
            <div class="task-option-description">{{ task.description }}</div>
          </div>
        </div>
        <button 
          class="task-selector-dismiss"
          (click)="showTaskSelector = false"
        >
          Dismiss
        </button>
      </div>
    </div>

    <!-- Response Display -->
    <div *ngIf="response" class="response-container">
      <div class="response-sections-horizontal">
        <div class="response-section">
          <h3>Classification</h3>
          <div class="response-content">
            <p><strong>Task ID:</strong> {{ response.taskId || 'N/A' }}</p>
            <p><strong>Task Name:</strong> {{ response.taskName || 'N/A' }}</p>
          </div>
        </div>

        <div *ngIf="response.extractedEntities && getObjectEntries(response.extractedEntities).length > 0" class="response-section">
          <h3>Extracted Entities</h3>
          <div class="response-content">
            <p *ngFor="let entry of getObjectEntries(response.extractedEntities)">
              <strong *ngIf="entry[1]">{{ entry[0] }}:</strong> <span *ngIf="entry[1]">{{ entry[1] }}</span>
            </p>
          </div>
        </div>
      </div>

      <div *ngIf="response.warnings && response.warnings.length > 0" class="response-section">
        <h3>Warnings</h3>
        <div class="response-content">
          <p *ngFor="let warning of response.warnings" style="color: #ff9800">‚ö†Ô∏è {{ warning }}</p>
        </div>
      </div>

      <div *ngIf="response.steps" class="response-section">
        <h3>Runbook Steps</h3>
        <div class="response-content">
          <!-- Prechecks -->
          <div *ngIf="response.steps.prechecks && response.steps.prechecks.length > 0" class="step-group">
            <h4 class="step-group-header">Pre-checks</h4>
            <div class="steps-container">
              <div *ngFor="let step of response.steps.prechecks; let idx = index" class="step-wrapper">
                <div class="step-row">
                  <div class="step-card" [ngClass]="getStepStatusClass(getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.status)">
                    <div class="step-content">
                      <div class="step-header">
                        <span class="step-number">{{ step.stepNumber }}</span>
                        <div class="step-info">
                          <span class="step-name-with-api" [title]="step.description + ' ' + step.method + ' ' + step.path">
                            {{ step.description }} <span class="step-method">{{ step.method }}</span> <span class="step-path">{{ step.path }}</span>
                          </span>
                        </div>
                        <span class="step-status" [ngClass]="getStepStatusClass(getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.status)">
                          {{ getStepStatusIcon(getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.status) }}
                        </span>
                      </div>
                    </div>
                    <div class="step-actions">
                      <ng-container *ngIf="!getStepExecution(getStepId(response.taskId, 'prechecks', idx)) && !isExecuting(getStepId(response.taskId, 'prechecks', idx))">
                        <ng-container *ngIf="hasPreviousStepFailed(idx, 'prechecks', response)">
                          <span class="blocked-message" style="font-size: 0.85rem; color: #ff9800">‚è∏ Blocked by previous failure</span>
                        </ng-container>
                        <button
                          *ngIf="!hasPreviousStepFailed(idx, 'prechecks', response) && step.autoExecutable"
                          class="step-button auto-execute"
                          (click)="executeStep(idx, step, response, 'prechecks')"
                        >
                          Run
                        </button>
                        <button
                          *ngIf="!hasPreviousStepFailed(idx, 'prechecks', response) && !step.autoExecutable"
                          class="step-button approve"
                          (click)="executeStep(idx, step, response, 'prechecks', true)"
                        >
                          Approve & Run
                        </button>
                        <button
                          *ngIf="hasPreviousStepFailed(idx, 'prechecks', response) && step.autoExecutable"
                          class="step-button auto-execute"
                          [disabled]="true"
                          style="opacity: 0.5; cursor: not-allowed;"
                        >
                          Run
                        </button>
                        <button
                          *ngIf="hasPreviousStepFailed(idx, 'prechecks', response) && !step.autoExecutable"
                          class="step-button approve"
                          [disabled]="true"
                          style="opacity: 0.5; cursor: not-allowed;"
                        >
                          Approve & Run
                        </button>
                      </ng-container>
                      <span *ngIf="isExecuting(getStepId(response.taskId, 'prechecks', idx))" class="executing" style="font-size: 0.85rem">‚ü≥ Running...</span>
                      <span *ngIf="getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.status === 'CANCELLED'" style="font-size: 0.85rem; color: #90a4ae">‚úó Cancelled</span>
                    </div>
                  </div>
                  <div *ngIf="getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.result || getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.errorMessage" class="step-message-container">
                      <div *ngIf="getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.result" class="step-details" [ngClass]="getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.result?.success ? 'success' : 'error'">
                        {{ getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.result?.success ? '‚úì ' : '‚úó ' }}
                        {{ parseMessage(getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.result?.message) || getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.result?.data?.status || 'Completed' }}
                      </div>
                      <div *ngIf="getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.errorMessage" class="step-details error">
                        ‚úó {{ getStepExecution(getStepId(response.taskId, 'prechecks', idx))?.errorMessage }}
                      </div>
                    </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Procedure -->
          <div *ngIf="response.steps.procedure && response.steps.procedure.length > 0" class="step-group">
            <h4 class="step-group-header">Procedure</h4>
            <div class="steps-container">
              <div *ngFor="let step of response.steps.procedure; let idx = index" class="step-wrapper">
                <div class="step-row">
                  <div class="step-card" [ngClass]="getStepStatusClass(getStepExecution(getStepId(response.taskId, 'procedure', idx))?.status)">
                    <div class="step-content">
                      <div class="step-header">
                        <span class="step-number">{{ step.stepNumber }}</span>
                        <div class="step-info">
                          <span class="step-name-with-api" [title]="step.description + ' ' + step.method + ' ' + step.path">
                            {{ step.description }} <span class="step-method">{{ step.method }}</span> <span class="step-path">{{ step.path }}</span>
                          </span>
                        </div>
                        <span class="step-status" [ngClass]="getStepStatusClass(getStepExecution(getStepId(response.taskId, 'procedure', idx))?.status)">
                          {{ getStepStatusIcon(getStepExecution(getStepId(response.taskId, 'procedure', idx))?.status) }}
                        </span>
                      </div>
                    </div>
                    <div class="step-actions">
                      <ng-container *ngIf="!getStepExecution(getStepId(response.taskId, 'procedure', idx)) && !isExecuting(getStepId(response.taskId, 'procedure', idx))">
                        <ng-container *ngIf="hasPreviousStepFailed(idx, 'procedure', response)">
                          <span class="blocked-message" style="font-size: 0.85rem; color: #ff9800">‚è∏ Blocked by previous failure</span>
                        </ng-container>
                        <button
                          *ngIf="!hasPreviousStepFailed(idx, 'procedure', response) && step.autoExecutable"
                          class="step-button auto-execute"
                          (click)="executeStep(idx, step, response, 'procedure')"
                        >
                          Run
                        </button>
                        <button
                          *ngIf="!hasPreviousStepFailed(idx, 'procedure', response) && !step.autoExecutable"
                          class="step-button approve"
                          (click)="executeStep(idx, step, response, 'procedure', true)"
                        >
                          Approve & Run
                        </button>
                        <button
                          *ngIf="hasPreviousStepFailed(idx, 'procedure', response) && step.autoExecutable"
                          class="step-button auto-execute"
                          [disabled]="true"
                          style="opacity: 0.5; cursor: not-allowed;"
                        >
                          Run
                        </button>
                        <button
                          *ngIf="hasPreviousStepFailed(idx, 'procedure', response) && !step.autoExecutable"
                          class="step-button approve"
                          [disabled]="true"
                          style="opacity: 0.5; cursor: not-allowed;"
                        >
                          Approve & Run
                        </button>
                      </ng-container>
                      <span *ngIf="isExecuting(getStepId(response.taskId, 'procedure', idx))" class="executing" style="font-size: 0.85rem">‚ü≥ Running...</span>
                      <span *ngIf="getStepExecution(getStepId(response.taskId, 'procedure', idx))?.status === 'CANCELLED'" style="font-size: 0.85rem; color: #90a4ae">‚úó Cancelled</span>
                    </div>
                  </div>
                  <div *ngIf="getStepExecution(getStepId(response.taskId, 'procedure', idx))?.result || getStepExecution(getStepId(response.taskId, 'procedure', idx))?.errorMessage" class="step-message-container">
                    <div *ngIf="getStepExecution(getStepId(response.taskId, 'procedure', idx))?.result" class="step-details" [ngClass]="getStepExecution(getStepId(response.taskId, 'procedure', idx))?.result?.success ? 'success' : 'error'">
                      {{ getStepExecution(getStepId(response.taskId, 'procedure', idx))?.result?.success ? '‚úì ' : '‚úó ' }}
                      {{ parseMessage(getStepExecution(getStepId(response.taskId, 'procedure', idx))?.result?.message) || getStepExecution(getStepId(response.taskId, 'procedure', idx))?.result?.data?.status || 'Completed' }}
                    </div>
                    <div *ngIf="getStepExecution(getStepId(response.taskId, 'procedure', idx))?.errorMessage" class="step-details error">
                      ‚úó {{ getStepExecution(getStepId(response.taskId, 'procedure', idx))?.errorMessage }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Postchecks -->
          <div *ngIf="response.steps.postchecks && response.steps.postchecks.length > 0" class="step-group">
            <h4 class="step-group-header">Post-checks</h4>
            <div class="steps-container">
              <div *ngFor="let step of response.steps.postchecks; let idx = index" class="step-wrapper">
                <div class="step-row">
                  <div class="step-card" [ngClass]="getStepStatusClass(getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.status)">
                    <div class="step-content">
                      <div class="step-header">
                        <span class="step-number">{{ step.stepNumber }}</span>
                        <div class="step-info">
                          <span class="step-name-with-api" [title]="step.description + ' ' + step.method + ' ' + step.path">
                            {{ step.description }} <span class="step-method">{{ step.method }}</span> <span class="step-path">{{ step.path }}</span>
                          </span>
                        </div>
                        <span class="step-status" [ngClass]="getStepStatusClass(getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.status)">
                          {{ getStepStatusIcon(getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.status) }}
                        </span>
                      </div>
                    </div>
                    <div class="step-actions">
                      <ng-container *ngIf="!getStepExecution(getStepId(response.taskId, 'postchecks', idx)) && !isExecuting(getStepId(response.taskId, 'postchecks', idx))">
                        <ng-container *ngIf="hasPreviousStepFailed(idx, 'postchecks', response)">
                          <span class="blocked-message" style="font-size: 0.85rem; color: #ff9800">‚è∏ Blocked by previous failure</span>
                        </ng-container>
                        <button
                          *ngIf="!hasPreviousStepFailed(idx, 'postchecks', response) && step.autoExecutable"
                          class="step-button auto-execute"
                          (click)="executeStep(idx, step, response, 'postchecks')"
                        >
                          Run
                        </button>
                        <button
                          *ngIf="!hasPreviousStepFailed(idx, 'postchecks', response) && !step.autoExecutable"
                          class="step-button approve"
                          (click)="executeStep(idx, step, response, 'postchecks', true)"
                        >
                          Approve & Run
                        </button>
                        <button
                          *ngIf="hasPreviousStepFailed(idx, 'postchecks', response) && step.autoExecutable"
                          class="step-button auto-execute"
                          [disabled]="true"
                          style="opacity: 0.5; cursor: not-allowed;"
                        >
                          Run
                        </button>
                        <button
                          *ngIf="hasPreviousStepFailed(idx, 'postchecks', response) && !step.autoExecutable"
                          class="step-button approve"
                          [disabled]="true"
                          style="opacity: 0.5; cursor: not-allowed;"
                        >
                          Approve & Run
                        </button>
                      </ng-container>
                      <span *ngIf="isExecuting(getStepId(response.taskId, 'postchecks', idx))" class="executing" style="font-size: 0.85rem">‚ü≥ Running...</span>
                      <span *ngIf="getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.status === 'CANCELLED'" style="font-size: 0.85rem; color: #90a4ae">‚úó Cancelled</span>
                    </div>
                  </div>
                  <div *ngIf="getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.result || getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.errorMessage" class="step-message-container">
                    <div *ngIf="getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.result" class="step-details" [ngClass]="getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.result?.success ? 'success' : 'error'">
                      {{ getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.result?.success ? '‚úì ' : '‚úó ' }}
                      {{ parseMessage(getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.result?.message) || getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.result?.data?.status || 'Completed' }}
                    </div>
                    <div *ngIf="getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.errorMessage" class="step-details error">
                      ‚úó {{ getStepExecution(getStepId(response.taskId, 'postchecks', idx))?.errorMessage }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Rollback -->
          <div *ngIf="response.steps.rollback && response.steps.rollback.length > 0" class="step-group">
            <h4 class="step-group-header">Rollback</h4>
            <div class="steps-container">
              <div *ngFor="let step of response.steps.rollback; let idx = index" class="step-wrapper">
                <div class="step-row">
                  <div class="step-card" [ngClass]="getStepStatusClass(getStepExecution(getStepId(response.taskId, 'rollback', idx))?.status)">
                    <div class="step-content">
                      <div class="step-header">
                        <span class="step-number">{{ step.stepNumber }}</span>
                        <div class="step-info">
                          <span class="step-name-with-api" [title]="step.description + ' ' + step.method + ' ' + step.path">
                            {{ step.description }} <span class="step-method">{{ step.method }}</span> <span class="step-path">{{ step.path }}</span>
                          </span>
                        </div>
                        <span class="step-status" [ngClass]="getStepStatusClass(getStepExecution(getStepId(response.taskId, 'rollback', idx))?.status)">
                          {{ getStepStatusIcon(getStepExecution(getStepId(response.taskId, 'rollback', idx))?.status) }}
                        </span>
                      </div>
                    </div>
                    <div class="step-actions">
                      <ng-container *ngIf="!getStepExecution(getStepId(response.taskId, 'rollback', idx)) && !isExecuting(getStepId(response.taskId, 'rollback', idx))">
                        <ng-container *ngIf="hasPreviousStepFailed(idx, 'rollback', response)">
                          <span class="blocked-message" style="font-size: 0.85rem; color: #ff9800">‚è∏ Blocked by previous failure</span>
                        </ng-container>
                        <button
                          *ngIf="!hasPreviousStepFailed(idx, 'rollback', response) && step.autoExecutable"
                          class="step-button auto-execute"
                          (click)="executeStep(idx, step, response, 'rollback')"
                        >
                          Run
                        </button>
                        <button
                          *ngIf="!hasPreviousStepFailed(idx, 'rollback', response) && !step.autoExecutable"
                          class="step-button approve"
                          (click)="executeStep(idx, step, response, 'rollback', true)"
                        >
                          Approve & Run
                        </button>
                        <button
                          *ngIf="hasPreviousStepFailed(idx, 'rollback', response) && step.autoExecutable"
                          class="step-button auto-execute"
                          [disabled]="true"
                          style="opacity: 0.5; cursor: not-allowed;"
                        >
                          Run
                        </button>
                        <button
                          *ngIf="hasPreviousStepFailed(idx, 'rollback', response) && !step.autoExecutable"
                          class="step-button approve"
                          [disabled]="true"
                          style="opacity: 0.5; cursor: not-allowed;"
                        >
                          Approve & Run
                        </button>
                      </ng-container>
                      <span *ngIf="isExecuting(getStepId(response.taskId, 'rollback', idx))" class="executing" style="font-size: 0.85rem">‚ü≥ Running...</span>
                      <span *ngIf="getStepExecution(getStepId(response.taskId, 'rollback', idx))?.status === 'CANCELLED'" style="font-size: 0.85rem; color: #90a4ae">‚úó Cancelled</span>
                    </div>
                  </div>
                  <div *ngIf="getStepExecution(getStepId(response.taskId, 'rollback', idx))?.result || getStepExecution(getStepId(response.taskId, 'rollback', idx))?.errorMessage" class="step-message-container">
                    <div *ngIf="getStepExecution(getStepId(response.taskId, 'rollback', idx))?.result" class="step-details" [ngClass]="getStepExecution(getStepId(response.taskId, 'rollback', idx))?.result?.success ? 'success' : 'error'">
                      {{ getStepExecution(getStepId(response.taskId, 'rollback', idx))?.result?.success ? '‚úì ' : '‚úó ' }}
                      {{ parseMessage(getStepExecution(getStepId(response.taskId, 'rollback', idx))?.result?.message) || getStepExecution(getStepId(response.taskId, 'rollback', idx))?.result?.data?.status || 'Completed' }}
                    </div>
                    <div *ngIf="getStepExecution(getStepId(response.taskId, 'rollback', idx))?.errorMessage" class="step-details error">
                      ‚úó {{ getStepExecution(getStepId(response.taskId, 'rollback', idx))?.errorMessage }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
